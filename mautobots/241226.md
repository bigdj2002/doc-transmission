í…Œë¼í¼ ì½”ë“œì—ì„œ ìŠ¤í¬ë¦½íŠ¸ ëª…ë ¹ì–´ì™€ ê´€ë ¨ëœ ë‚´ìš©ì„ ì œê±°í•˜ê³ , ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ì™€ ë¹Œë“œìŠ¤í™ íŒŒì¼ë§Œìœ¼ë¡œ ê´€ë¦¬í•˜ë„ë¡ êµ¬ì¡°ë¥¼ ìˆ˜ì •í•˜ê² ìŠµë‹ˆë‹¤. ì•„ë˜ëŠ” Terraform ì½”ë“œì™€ ë¹Œë“œ/ë°°í¬ êµ¬ì¡°ë¥¼ ëª…í™•íˆ ë¶„ë¦¬í•œ ìµœì¢… ì„¤ê³„ì…ë‹ˆë‹¤.

1. Terraform ì½”ë“œ ë””ë ‰í† ë¦¬ êµ¬ì¡°

Terraform ì½”ë“œëŠ” í™˜ê²½ë³„ë¡œ êµ¬ë¶„ë˜ë©°, Terraform ìì²´ì—ëŠ” ìŠ¤í¬ë¦½íŠ¸ ëª…ë ¹ì–´ë‚˜ ë°°í¬ ê´€ë ¨ ë™ì‘ì´ í¬í•¨ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

terraform/
â”œâ”€â”€ dev/
â”‚   â”œâ”€â”€ codepipeline/
â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â”œâ”€â”€ outputs.tf
â”‚   â”œâ”€â”€ service/                # ê¸°ì¡´ infrastructure ë””ë ‰í† ë¦¬
â”‚       â”œâ”€â”€ main.tf
â”‚       â”œâ”€â”€ variables.tf
â”‚       â”œâ”€â”€ outputs.tf
â”œâ”€â”€ prod/
â”‚   â”œâ”€â”€ codepipeline/
â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â”œâ”€â”€ outputs.tf
â”‚   â”œâ”€â”€ service/
â”‚       â”œâ”€â”€ main.tf
â”‚       â”œâ”€â”€ variables.tf
â”‚       â”œâ”€â”€ outputs.tf
â”œâ”€â”€ providers.tf                # ê³µí†µ AWS ì œê³µì ì„¤ì •

2. ë°°í¬ ìŠ¤í¬ë¦½íŠ¸

Terraform ëª…ë ¹ì–´ë¥¼ í™˜ê²½ë³„ë¡œ ì‹¤í–‰í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤. ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” Terraform ì½”ë“œì™€ ì™„ì „íˆ ë¶„ë¦¬ëœ ìƒíƒœë¡œ ë™ì‘í•˜ë©°, Terraform ì½”ë“œì—ëŠ” ë°°í¬ì™€ ê´€ë ¨ëœ ìŠ¤í¬ë¦½íŠ¸ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.

ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ (scripts/deploy.sh)

#!/bin/bash
set -e

if [ $# -ne 3 ]; then
  echo "Usage: $0 <codepipeline|service> <dev|prod> <action>"
  echo "Actions: plan | apply | destroy"
  exit 1
fi

TARGET=$1       # codepipeline or service
ENV=$2          # dev or prod
ACTION=$3       # plan, apply, destroy

echo "Running Terraform for $TARGET in $ENV environment..."

# ì´ë™í•˜ì—¬ Terraform ì‹¤í–‰
cd terraform/$ENV/$TARGET

# Terraform ì´ˆê¸°í™”
terraform init

# Terraform ëª…ë ¹ ì‹¤í–‰
if [ "$ACTION" == "plan" ]; then
  terraform plan -out=tfplan
elif [ "$ACTION" == "apply" ]; then
  terraform apply -auto-approve tfplan
elif [ "$ACTION" == "destroy" ]; then
  terraform destroy -auto-approve
else
  echo "Invalid action: $ACTION"
  exit 1
fi

echo "Terraform $ACTION completed for $TARGET in $ENV environment."

ì‚¬ìš© ë°©ë²•

# dev í™˜ê²½ì˜ CodePipeline ë°°í¬
./scripts/deploy.sh codepipeline dev apply

# prod í™˜ê²½ì˜ ì„œë¹„ìŠ¤ ë°°í¬
./scripts/deploy.sh service prod apply

# dev í™˜ê²½ì˜ ì„œë¹„ìŠ¤ ì‚­ì œ
./scripts/deploy.sh service dev destroy

3. ë¹Œë“œìŠ¤í™ íŒŒì¼ (buildspec.yml)

Terraform ì‘ì—…ì€ ë¹Œë“œìŠ¤í™ íŒŒì¼ì—ì„œ ì œì™¸ë˜ë©°, Lambda ì½”ë“œ ë°°í¬ë§Œì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.

ìˆ˜ì •ëœ buildspec.yml

version: 0.2

phases:
  install:
    commands:
      - echo "Installing required tools..."
      - curl -O https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip
      - unzip terraform_1.6.0_linux_amd64.zip
      - mv terraform /usr/local/bin/
      - echo "Tools installed successfully."

  build:
    commands:
      - echo "Starting deployment process for target: $DEPLOY_TARGET"
      - |
        case "$DEPLOY_TARGET" in
          lambda-code)
            echo "Packaging and Deploying Lambda function code..."
            ./scripts/package_lambda.sh
            aws lambda update-function-code \
              --function-name "$LAMBDA_FUNCTION_NAME" \
              --zip-file "fileb://lambda.zip" \
              --region "$AWS_REGION"
            aws lambda publish-version \
              --function-name "$LAMBDA_FUNCTION_NAME" \
              --region "$AWS_REGION"
            echo "Lambda code deployment completed."
            ;;
          *)
            echo "Error: Invalid DEPLOY_TARGET value '$DEPLOY_TARGET'"
            exit 1
            ;;
        esac

  post_build:
    commands:
      - echo "Deployment process for $DEPLOY_TARGET completed successfully."

í™˜ê²½ ë³€ìˆ˜
	â€¢	DEPLOY_TARGET: í˜„ì¬ëŠ” lambda-codeë§Œ ì‚¬ìš©.
	â€¢	LAMBDA_FUNCTION_NAME ë° AWS_REGION: Lambda ì½”ë“œ ë°°í¬ì— í•„ìš”í•œ ì •ë³´.

4. Terraform ì½”ë“œ ì˜ˆì œ

Terraform ì½”ë“œì—ëŠ” ë‹¨ìˆœíˆ AWS ë¦¬ì†ŒìŠ¤ë¥¼ ì •ì˜í•˜ë©°, ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ì™€ì˜ ì˜ì¡´ì„±ì„ ì™„ì „íˆ ì œê±°í•©ë‹ˆë‹¤.

terraform/dev/service/main.tf

resource "aws_lambda_function" "example_lambda" {
  function_name = "my-dev-lambda-function"
  runtime       = "python3.9"
  handler       = "src.app.lambda_handler"
  role          = aws_iam_role.lambda_exec.arn
  s3_bucket     = aws_s3_bucket.dev_bucket.id
  s3_key        = "lambda.zip"
  memory_size   = 128
  timeout       = 10
}

terraform/prod/service/main.tf

resource "aws_lambda_function" "example_lambda" {
  function_name = "my-prod-lambda-function"
  runtime       = "python3.9"
  handler       = "src.app.lambda_handler"
  role          = aws_iam_role.lambda_exec.arn
  s3_bucket     = aws_s3_bucket.prod_bucket.id
  s3_key        = "lambda.zip"
  memory_size   = 256
  timeout       = 15
}

5. í™˜ê²½ë³„ ë°°í¬ ìˆœì„œ

1. CodePipeline ë°°í¬

./scripts/deploy.sh codepipeline dev apply
./scripts/deploy.sh codepipeline prod apply

2. ì¸í”„ë¼ ë°°í¬ (Service)

./scripts/deploy.sh service dev apply
./scripts/deploy.sh service prod apply

3. Lambda ì½”ë“œ ë°°í¬

Lambda ì½”ë“œ ë°°í¬ëŠ” CodeBuildë¥¼ í†µí•´ ìˆ˜í–‰ë©ë‹ˆë‹¤:

aws codebuild start-build \
  --project-name "my-codebuild-project" \
  --environment-variables-override name=DEPLOY_TARGET,value=lambda-code,type=PLAINTEXT \
                                   name=LAMBDA_FUNCTION_NAME,value=my-dev-lambda-function,type=PLAINTEXT \
                                   name=AWS_REGION,value=ap-northeast-2,type=PLAINTEXT

6. ê²°ë¡ 
	1.	Terraform ì‘ì—…ì€ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸(deploy.sh)ë¡œë§Œ ì‹¤í–‰í•˜ë©°, Terraform ì½”ë“œì™€ ëª…ë ¹ì–´ëŠ” ë¶„ë¦¬.
	2.	ë¹Œë“œìŠ¤í™ íŒŒì¼ì€ Lambda ì½”ë“œ ë°°í¬ë§Œ ì²˜ë¦¬.
	3.	í™˜ê²½ë³„ ë””ë ‰í† ë¦¬ êµ¬ì¡°ë¥¼ ìœ ì§€í•˜ë©°, ë°°í¬ ìˆœì„œë¥¼ ëª…í™•íˆ êµ¬ë¶„.

ì´ êµ¬ì¡°ëŠ” í™˜ê²½ë³„ ë°°í¬ì˜ ì•ˆì „ì„±ê³¼ Terraform ì½”ë“œì˜ ë…ë¦½ì„±ì„ ëª¨ë‘ ë³´ì¥í•©ë‹ˆë‹¤. ğŸ¯
